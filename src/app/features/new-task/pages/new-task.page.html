<div class="new-task-page">
  <!-- Header con botón de volver -->
  <div class="page-header">
    <button class="btn-back" (click)="onBack()">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="btn-back-icon"
      >
        <path d="m12 19-7-7 7-7"></path>
        <path d="M19 12H5"></path>
      </svg>
      <span class="btn-back-text">Volver</span>
    </button>
    <h1>Nueva tarea</h1>
  </div>

  <!-- Contenido principal -->
  <div class="content">
    <div class="form-container">
      <!-- Selector de rutina -->
      <app-routine-selector></app-routine-selector>
      <!-- Formulario de tarea -->
      <app-shared-task-form></app-shared-task-form>
    </div>
    <div class="preview-container">
      <!-- Vista previa de tareas -->
      <app-preview-shared mode="task"></app-preview-shared>

      @if (!isValid()) {
      <div class="validation-message">
        <p class="validation-text">Para guardar las tareas necesitas:</p>
        <ul class="validation-list">
          <li [class.completed]="taskStateService.selectedRoutine().trim().length > 0">
            <span class="check-icon">{{ taskStateService.selectedRoutine().trim().length > 0 ? '✓' : '○' }}</span>
            Seleccionar una rutina
          </li>
          <li [class.completed]="taskStateService.hasTasks()">
            <span class="check-icon">{{ taskStateService.hasTasks() ? '✓' : '○' }}</span>
            Agregar al menos una tarea
          </li>
        </ul>
      </div>
      } @if (createError()) {
      <div class="error-message">
        <div class="error-content">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="error-icon"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
          <span>{{ createError() }}</span>
        </div>
        <button class="btn-retry" (click)="createError.set(null)">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M18 6L6 18"></path>
            <path d="M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      }

      <button
        class="btn-save"
        [disabled]="!isValid() || isCreatingTasks()"
        [class.disabled]="!isValid() || isCreatingTasks()"
        [class.loading]="isCreatingTasks()"
        (click)="onSaveTasks()"
        [title]="
          isCreatingTasks()
            ? 'Creando tareas...'
            : isValid()
            ? 'Guardar tareas'
            : 'Completa todos los campos requeridos'
        "
      >
        @if (isCreatingTasks()) {
        <span class="loading-spinner"></span>
        <span>Creando tareas...</span>
        } @else {
        <span
          >{{ isValid() ? 'Guardar ' + taskStateService.taskCount() + ' tarea' + (taskStateService.taskCount() === 1 ?
          '' : 's') + ' en ' + taskStateService.selectedRoutine() : 'Completar información requerida' }}</span
        >
        }
      </button>
    </div>
  </div>
</div>
